{% extends "base.html" %}

{% block title %}Manage Batches - Smart Classroom Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-users me-2"></i>Manage Batches</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBatchModal">
                <i class="fas fa-plus me-2"></i>Add Batch
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Search Container -->
                <div class="search-container">
                    <input type="text" class="search-input" id="batchSearch" placeholder="Search batches by name, department, or semester...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="batchesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Semester</th>
                                <th>Student Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Batch Modal -->
<div class="modal fade" id="addBatchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBatchForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Batch Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="e.g., CS-3A" required>
                    </div>
                    <div class="mb-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Electronics">Electronics</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="semester" class="form-label">Semester</label>
                        <select class="form-select" id="semester" name="semester" required>
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                            <option value="7">7th Semester</option>
                            <option value="8">8th Semester</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="student_count" class="form-label">Student Count</label>
                        <input type="number" class="form-control" id="student_count" name="student_count" min="1" max="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBatch()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Batch Modal -->
<div class="modal fade" id="editBatchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBatchForm">
                    <input type="hidden" id="editBatchId" name="id">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Batch Name</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDepartment" class="form-label">Department</label>
                        <select class="form-select" id="editDepartment" name="department" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Electronics">Electronics</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSemester" class="form-label">Semester</label>
                        <select class="form-select" id="editSemester" name="semester" required>
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                            <option value="7">7th Semester</option>
                            <option value="8">8th Semester</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStudentCount" class="form-label">Student Count</label>
                        <input type="number" class="form-control" id="editStudentCount" name="student_count" min="1" max="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateBatch()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadBatches();
    initializeSearch('batchesTable', 'batchSearch');
});

function loadBatches() {
    $.get('/api/batches', function(data) {
        const tbody = $('#batchesTable tbody');
        tbody.empty();
        
        if (data && data.success && data.batches && data.batches.length > 0) {
            data.batches.forEach(function(batch) {
                const row = `
                    <tr>
                        <td><strong>${batch.name}</strong></td>
                        <td><span class="badge bg-info">${batch.department}</span></td>
                        <td>${batch.semester}</td>
                        <td>${batch.student_count}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editBatch(${batch.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBatch(${batch.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.append('<tr><td colspan="5" class="text-center">No batches found</td></tr>');
        }
    }).fail(function(xhr, status, error) {
        console.error('Error loading batches:', xhr.responseText);
        const tbody = $('#batchesTable tbody');
        tbody.empty();
        tbody.append('<tr><td colspan="5" class="text-center text-danger">Error loading batches</td></tr>');
    });
}

function saveBatch() {
    const formData = {
        name: $('#name').val(),
        department: $('#department').val(),
        semester: parseInt($('#semester').val()),
        student_count: parseInt($('#student_count').val())
    };
    
    $.ajax({
        url: '/api/batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#addBatchModal').modal('hide');
                $('#addBatchForm')[0].reset();
                loadBatches();
                showAlert('Batch added successfully!', 'success');
            }
        },
        error: function() {
            showAlert('Error adding batch!', 'danger');
        }
    });
}

function editBatch(id) {
    $.get('/api/batches', function(data) {
        let batch = null;
        if (data && data.success && Array.isArray(data.batches)) {
            batch = data.batches.find(b => b.id === id);
        }
        if (batch) {
            $('#editBatchId').val(batch.id);
            $('#editName').val(batch.name);
            $('#editDepartment').val(batch.department);
            $('#editSemester').val(batch.semester);
            $('#editStudentCount').val(batch.student_count);
            $('#editBatchModal').modal('show');
        } else {
            showAlert('Batch not found!', 'danger');
        }
    }).fail(function(xhr, status, error) {
        console.error('Error loading batch data:', xhr.responseText);
        showAlert('Error loading batch data!', 'danger');
    });
}

function updateBatch() {
    const id = $('#editBatchId').val();
    const formData = {
        name: $('#editName').val(),
        department: $('#editDepartment').val(),
        semester: parseInt($('#editSemester').val()),
        student_count: parseInt($('#editStudentCount').val())
    };
    
    $.ajax({
        url: `/api/batches/${id}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#editBatchModal').modal('hide');
                showAlert('Batch updated successfully!', 'success');
                loadBatches();
            } else {
                showAlert(response.error || 'Error updating batch!', 'danger');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Error updating batch!';
            showAlert(errorMsg, 'danger');
        }
    });
}

function deleteBatch(id) {
    if (confirm('Are you sure you want to delete this batch?')) {
        $.ajax({
            url: `/api/batches/${id}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert('Batch deleted successfully!', 'success');
                    loadBatches();
                } else {
                    showAlert(response.error || 'Error deleting batch!', 'danger');
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.error || 'Error deleting batch!';
                showAlert(errorMsg, 'danger');
            }
        });
    }
}

// Handle edit batch form submission
$('#editBatchForm').on('submit', function(e) {
    e.preventDefault();
    updateBatch();
});
</script>
{% endblock %}
